
## イントロダクション

---

### 本書の目的

本書の目的は、他人が理解しやすいコードを書くことである。

ここで言う「他人」とは、不具合修正・引き継ぎを行う人や、数カ月後の自分も含まれます。

ここで言う「理解」とは、読めるだけでなくバグを見つけたり修正したりできるレベルで理解できることです。（他の機能との連携や階層化についてはここでは触れません）

---

### 本講座の目的
個人の趣味、組み込み系、または受託開発（売り切り）のシステムであれば、一度作って動いてしまえばどうとでもなります。

しかし、パッケージとして作られたシステムの場合は、自分のコードが他人に保守され、拡張されていく必要があります。
その際、既に動いてしまってお客さんに使われている汚いコードは、財産などではなく技術的な負債とみなされます。（もちろんカタログは財産ですが。）

---

### 本講座の目的
そのため、この講座では「何が汚いコードなのか」「どうすれば読みやすくなるのか」といった判断の指針として学んでいければいいなと思っています。

実務でこの姿勢が評価されるかは怪しいところですが、今後のプログラマとしてのキャリアを積んでいく中で、一般的に良いと言われている思想や考え方を身につけるのは損はないと考えています。

---

### 導入

そもそも優れたコードって？


---

### どちらが良いコード？

```java
return exponent >= 0 ? mantissa * (1 << exponent) : mantissa / (1 << -exponent) ;
```
        

```java
if (exponent >= 0) { 
    return mantissa * (1 << exponent); 
} else { 
    return mantissa / (1 << -exponent); 
```

おっと。Javaじゃないので少し読みにくいかもしれませんね（コピペなもので）。以降はなるべくJavaで記述することにします。

上は三項演算子、下はif分岐ですね。上の方が行数は短いですが、下のほうが理解が早いでしょうか。

---

### 読みやすさの基本定理
コードは、他人が最短時間で理解できるように書かなければいけない。

ちょっとプログラムが書けるようになってくると、ムリヤリ短いコードにしようととしてみたり、素晴らしく難しいアルゴリズムを思いついて一気に100行くらいのものを書き上げてしまったりします。 
（いずれも書いてる時は「俺、天才じゃね？」と思って書いているものです。）

しかし、難しいことを難しく伝えるのは簡単ですが、わかりやすく他人に伝えることは難しいです。ましてコードに表すとなると。 
しかし前述のとおり、「俺メソッド」で書かれた長大なコードはむしろ技術的負債です。

---

### ざっくりと概要

以下のことを基本方針として進めていきます

- なるべくコメントは書かない。コードに意味を込める。
- 一度に1つのことだけ行う
- 出来る限り書くな。似た処理はまとめろ。 
    - →デザインパターンやLayerの話は後日


---

### それってめんどくさい？

「自分の中ではわかってるのに、あえてわかりやすく書くなんてめんどくさい」 
そんな声が聞こえてきそうですが、開発者自身にもメリットがあります。

一目で理解しやすいコードというのは、適度に分割されて役割がはっきりしているでしょう。そうすると、テストを記述しやすくなったり、何かバグが起きた時に原因を特定しやすくなります。 
何より、他人の汚いコードとか見るの嫌でしょ？他人がポイ捨てしてるからって自分もしていいと思うかは倫理観の話。

---


### 目次
このような内容で進めていきます。

- 名前に情報を詰め込む
- 見た目のキレイさを大事に
- 何をコメントすべきか
- 時間配分をミスったので後日改めて。。。

---

### 名前に情報を詰め込む


---

### 概要

名前って大事

- 明確な単語を選ぶ
- 汎用的な名前は避ける
- 抽象的な名前より具体的に
- 接頭辞や接尾辞で情報を追加する
- フォーマットを統一してわかりやすく
- （Eclipseなら）長い名前でもあまり気にしない
- （※なるべく英語使おう。Syainとかやめよう）


---

### どっちがわかりやすい？

```java
              public GetPage(url){
              ...
            }
```

URLに応じてPageを取ってくるのはわかった。でもどこから？ローカル・インターネット・データベース、様々な解釈ができる。(Getterメソッドだと思われることもある。)

```java
              public DownloadPage(url){
              ...
            }
```

こちらはより明確だ。上の例はGetが曖昧だったことが良くなかったのだろう。


---

### どっちがわかりやすい？

```java
              class BinaryTree{
              int size;
              ...
            }
```

sizeって何のサイズだろう？要素数・長さ・メモリの量？（さらに言えば、単位も不明だ）

```java
              class BinaryTree{
              int NumNodes;
              ...
            }
```
            
ノードの数（葉の数・要素数）みたいだ。


---

### どっちがわかりやすい？

```java
              class Thread { 
                void Stop();
              ...
            }
```

スレッドが止まる。それって一時停止・終了？

```java
              class Thread { 
                void Pause();
              ...
            }
```

一時停止みたいだ。たぶん他にResume()メソッドとかあるんだろう。


---

### なるべくカラフルな単語を。

画像

thesaurus＝類語辞典 らしい。 
要は、GetとかSizeとかって抽象的な単語じゃなくて、より具体的にすべきということ。 
「恐竜」よりも、「ステゴサウルス」の方がイメージしやすいものね。


---

### よく使いそうな単語

- send -> deliver, dispatch, announce, distribute
- find -> search, extract, locate, recover
- start -> launch, create, begin, open
- make -> create, set up, build, generate, compose, add, new

※他にも募集します。「こんな単語使えるよ」とか「こういう処理なんだけど、もっといい単語ないかな？」など、何かあれば教えて。


---

### 汎用的な名前は避ける
例

- tmp
- val
- i, j, k
- String s, float f

これらの単語は、何も意味を持たない。何か変数を作るなら、そこには理由・用途があるはず。それを記述すべき。


---

### どっちがわかりやすい？

```java
              tmp = tempFile.NamedTemporaryFile()
              ...  
              SaveData (tmp, ...)
```

tmpへの代入メソッドを見れば、fileっぽいことはわかる。が、間の「...」の間に何か処理があったら、ファイルなのかファイル名だけかデータ自体かがわからなくなるだろう

```java
              tmp_file = tempFile.NamedTemporaryFile()
              ...  
              SaveData (tmp_file, ...)
```

こっちは、引数の変数名を見れば、ファイルを保存しようとしているんだな、とわかる。 
（もしかしたら、メソッド名をSaveFileData()とすべきかも）


---

### どっちがわかりやすい？

```java
              for (int i = 0; i < clubs.size(); i++) 
                for (int j = 0; j < clubs[i].members.size(); j++) 
                  for (int k = 0; k < users.size(); k++) 
                ...
java
こんな例があったのですが、そもそもJavaだと、二重三重のネストなんて読みたくもないし、for文使うにしても拡張for文だろうし、配列なんて使いたくないのでこの例は省略します。

ちょっとしたfor文に対してイテレータ（i, j, k）を使う分には問題はほとんどないと思います。


---

### どっちがわかりやすい？
16進数の文字列を持つ変数に名前をつけたい

```java
              String = id; //例 "af84ef845cd8"
```

コメントが何を表してるのか明確でない。

```java
              String = hex_id;
```

接頭辞をつけるだけで、何もコメントがなくてもわかりやすいし、コメントが書いてない行で使われていても問題なく理解できる。


---

### どっちがわかりやすい？
単位を気にする必要がある。

```java
              DateTime start = new DateTime;
              ...
              System.out.println("読み込み時間 " + (end - start) + "秒"
              );
```
            
単位は標準ではミリ秒だが、間違えて使ってしまっている。

```java
              DateTime start_ms = new DateTime;
              ...
              System.out.println("読み込み時間 " + (end_ms - start_ms)/1000 + "秒"
              );
```

単位を添えてあげると情報量が増える。時間だと間違いに気づきやすいかもしれないが、他にも、size_mb, height_cm などが挙げられる。


---

### どっちがわかりやすい？
セキュリティのため、ブラウザからPostされた文字列（json）をescapeする必要がある。

```java
              String comment = json;
              ...
```

どの文字列がescapeされたものかわからないので、デバッグしながら変更点を探すことになってしまう。

```java
              String unescaped_comment = json;
              ...
```

予めunescapedをつけておくことで、escapeされたタイミングがわかるし、万が一escape漏れがあっても気づきやすい。他にも、text_utf-8, password_plaintextなどがある。

---

### どっちがわかりやすい？
安易に省略形を使うべきでない

```java
              public class BEManager{
              ...
            }
```

自分の中では、何度も書くのがめんどくさいので略したのだろうが、初見の人が理解できるだろうか？

```java
              public class BackEndManager{
              ...
            }
```

eclipseならコード補完をしてくれるので、長い名前でも問題ない。（ただし、SRなどプロジェクト全体で意味を共有しているのであれば略しても構わない。）


---

### どっちがわかりやすい？
DBから取ってくる値をフィルタリングしたい。

```java
              result = Database.allObjects.filter("year <= 2011") 
```

filterの条件でもって「選択」されたのか「除外」されたのかわかりにくい

```java
              result = Database.allObjects.select("year <= 2011") 
```

こちらの方が、何を選んでいるのか明確になる。 
（ただし、ORMフレームワークを使っているとDBとのやりとりのメソッド名は決められていることが多い）


---

### どっちがわかりやすい？
textが長すぎる場合、一定値まで切りつめたい。

```java
              public clip(text, length){
```
            
textから「length文字まで切り詰める」のか、「length文字分を削除する」のかわかりにくい。

```java
              public truncate(text, length){
```
            
切り詰める方のようだとわかる。 
また、lengthという名前もわかりにくいので、max_lengthや、max_charの方が良い。


---

### どっちがわかりやすい？
カートの最大値が9の場合

```java
              int CART_ITEMS_LIMIT = 9;
```
            
上限なのか下限なのかもわかりにくいし、9まで入るのか、9は入らないのかもわかりにくい

```java
              int MAX_ITEMS_IN_CART = 9;
```
            
Maxはわかりやすい単語だ。 
境界値を含む数を扱うときは、量ならmaxやmin、順列ならfirst, lastを使うとわかりやすい。


---

### どっちがわかりやすい？
10/16に開かれたイベントをprintしたい。

```java
              PrintEventslnRange("OCT 16 12: 00am"， "OCT 16 11: 59:59.9999pm");
```

すごく気持ち悪い書き方だ。しかも、万が一59.99999に終わるイベントがあっても除外されてしまう。

```java
              printEventslnRange("OCT 16 12:00am"， "OCT 17 12 :00am");
```
            
こちらのほうが自然だろう。そのためにはprintEventslnRange(begin, end)のように定義する必要がある。 
英語には、「ちょうど最後の値を超えたところ」という表現がないので、begin, endが妥当。


---

### どっちがわかりやすい？
Passwordを確認済みか否かで処理を分けたい。

```java
              boolean readPassword = true;
```
            
readPasswordは何を表してる？「これから読みとる」「既に読み取った」がわからない。

```java
              boolean needPassword = true;
```
            
これなら、「これから読み取るんだな」とわかる。 
また、一般的なboolean型の変数なら、is, has, canなどの接頭辞がつくことが多い。


---

### まとめ

名前って大事

- 汎用的な名前は避ける（tmpやiに意味は無い）
- 抽象的な名前より具体的に（getやsizeは曖昧なことが多い）
- 接頭辞や接尾辞で情報を追加する(_ms, _utf-8など)
- フォーマットを統一してわかりやすく(プロジェクトで決まっているので省略した)
- 長い名前でもあまり気にしない(ムリに略すほうがわかりにくい)
- ※なるべく英語使おう。（カッコ悪いから。翻訳の手間を惜しまない。）


---

### 見た目のキレイさを求める


---

### 概要

優れたコードは、目にやさしいものであるべきだ。そのためには、余白・順序・配置などの書き方が重要になってくる。

美しいコード

- 読み手が慣れているパターンと一貫性のあるレイアウトを使う。
- 似ているコードは似ているように見せる。
- 関連するコードをまとめてブロックにする。


---

### どっちがわかりやすい？
キレイなコードとは、情報が適切に配置されていることだ。

```java
              public class StatsKeeper { 
              // doubleを記録するクラス
                public void Add (double d){
                ...
              } 
                private double minimum; 
                private double maximum;

                public double Average(){ // すばやく統計を出すメソッド
                ...
              }

                private list＜double＞ past_items;
                private int count; 
                
              }; 
```
            

```java
              // doubleを記録するクラスと
              // すばやく統計を出すメソッド
              public class StatsKeeper { 

                private list＜double＞ past_items;
                private int count; 
                private double minimum; 
                private double maximum;

                public void Add (double d){
```

---

### どっちがわかりやすい？
おなじテストコードでも、見た目を整えることで重複を防ぎ、テストの追加も簡単になった。

```java
              DatabaseConnection database connection; 
              string error; 
              assert(ExpandFullName(database_connection, "Doug Adams", &error)
              == "Mr. Douglas Adams"); 
              assert (error == ""); 
              assert(ExpandFullName(database_connection, "Jake Brown", &error) 
                == "Mr. Jacob Brown III" ); 
              assert(error == "");
              assert(ExpandFullName(database_connection, "No Such Guy" &error) == "");
              assert(error == "no match found"); 
              assert (ExpandFullName( database_connection, "John", &error) == ""); 
              assert (error == "more than one result" ); 
```

```java
              CheckFullName("Doug Adams", "Mr. Douglas Adams", ""); 
              CheckFullName(" Jake Brown ", " Mr. Jake Brown III", "");
              CheckFullName("No Such Guy", "", "no match found"); 
              CheckFullName("John", "", "nore than one result");

              void CheckFullName(string partial_name， 
                  string expected_full_name，
                  string expected _ error) { 
                // database_connectionはクラスのメンバになっている。
                String error; 
                String full_name = ExpandFullName(database_connection, partial_name, &error); 
```

---

### 本書では他にも様々な手法が紹介されているが、省略する。 

その他の手法（省略）

- 意味のある順番に並べる 
    - →処理していく順番に書くなど。
- コードを段落に分割する。 
    - →改行なく並べるよりも見やすくなることがある。
- 縦の線をまっすぐにする 
    - →似た記述を同じように見せることができる。


---

### 何をコメントすべきか

---

### コメントは安易に書くな

基本方針

- コードを読めばすぐにわかることは書かない 
    - →コメントを読ませるためにコードを読む時間を奪うことになる。
- コメントを残す前にコードを見なおせ。 
    - →コメントを書かなければ意味が分からなさそうであれば、おそらくコード自体がまずい。
- コメントも書いてしまったら保守する責任が生じる 
    - →誰かがコードを書き換えた時、コメントも書き換えなくてはならない
- 思考のプロセス・注意喚起・試行錯誤を書くのはよい 
    - →コードには表せないことを書くのなら有効である。

**「優れたコー ド >ひどいコード + 優れたコメン卜」**

---

### コメントが許されるパターン

コレ以外は基本的に書くべきでないと思って良いと思う

試行錯誤の結果を記述しておく 

```
//このデータだとハッシュテーブルよりもバイナリツリーのほうが40%速かった。 
//左右の比較よりもハッシュの計算コストのほうが高いようだ。
```

誰かに修正を依頼したい場合。 

```
//このメソッドは汚くなっている 
//いくつかのprivateメソッドに分割するのもいいかもしれない。
```

時間がなくて懸念点を残したままの時 

```
//TODO: このループは効率が悪い 
//注意 もしレコードが0だったらヌルポで落ちる。
```


---

### コメントが許されるパターン2

定数に対して、定めた理由を記す。 

```
final int MAX_ITEMS_IN_CART = 99 //物理的にこれ以上は不要。 
final int timeOut_ms = 1000; //ユーザーを待たせる限界値
```

誰かに修正を依頼したい場合。 

```
//このメソッドは汚くなっている 
//いくつかのprivateメソッドに分割するのもいいかもしれない。
```

読み手が不審に思いそうなことを書いておく 

```
String names[10] //一部java1.4なので、ジェネリクス使えない。 
//少し汚いが、この方が速く動くため採用している。
```

クラスの全体像を記す。 

```
//このクラスは値を一時的にキャッシュしておくためのオブジェクトを表す。 
//このクラスはユーザーの権限を確認するためのメソッド群が含まれている。
```


---

### コメントの書き方

これはどちらかというと国語力の話になりそうだが。。。

曖昧な記述。代名詞を避ける。 

```
//データをキャッシユに入れる。ただし、先にそのサイズをチェックする。 
↓ 
//データをキャッシュに入れる。ただし、先にデータのサイズをチェックする。
```

簡潔に伝える。 

```
//これまでにクロールしたURLかどうかによって優先度を変える。 
↓ 
//これまでにクロールしていないURLの優先度を高くする。
```

クラスの全体像を記す。 

```
//このファイルに含まれる行数を返す。 
↓ 
//このファイルに含まれる改行文字 ("\n")を数える。
```

---

### コメントの書き方２

実例を示す。 

```
//'src'の先頭や末尾にある 'chars'を除去する。 
↓ 
// 実例:Strip("bba/a/ba", "ab") は "/a/" を返す。
```

情報量が多い単語を使う 

```
//表記のわすかに違う住所を整形し、同じように扱う。 
↓ 
//所在地を正規化する (例: "Avenue" => "Ave.")
```

---

### まとめ

- コードを読んだ人が気になりそうなところにだけ記す。
- ファイルやクラスの全体像を記すのもあり。
- 読み手が国外の人なら日本語で書くべきでないかも。。
- ややこしいものは実例を示すのもアリ 

（※ただし、そのメソッドは本来は分割すべきものかも。）


コメントすべきことをしるためには、他人の平均的なレベルを知る必要がある。

---

### ループとロジックの単純化

---

### 概要

記述の仕方は色々あるが、初めはなるべく統一してしまおう

- 条件の並び順にも気をつける
- 三項演算子・do while文は使わない。
- なるべく読者の考える量を減らす。
- （拡張For文・ジェネリクス使おう） 
    - ->本書に記述はないのでここでは触れない

---

### 気になることは先に

画像

人が同時に考えられるのはせいぜい３つまでと言われています。引数がやたら多かったり、ネストが深いものは普通は理解できないでしょう
(※特に気になる部分が含まれていたらなおさら。）

---

### if文の並び順

なるべく、脳内のスタック(記憶量)を減らす。

- 関心を引く条件や目立つ条件を先に書く。
- 単純な条件を先に書く。ifとelseが同じ画面に表示されるので見やすい。
- 条件は否定形よりも肯定形を使う。

---

### どっちがわかりやすい？

```java
              if(!url.hasQueryParamater("expand_all")) { 
                response.Render(items) ; 
              }else{ 
                for (int i = 0; i< items.size(); i++) { 
                  items[i].expand();
```

「expand_allの場合は考えるな」って言われても気になりますよね。

```java
              if(url.hasQueryParamater("expand_all")) { 
                for (int i = 0; i< items.size(); i++) { 
                  items[i].expand();  
              }else{ 
                response.Render(items) ; 
```java

初めに、肯定文や特殊なものを処理してから「その他は〜」ってなるほうがわかりやすい

---

### 変数を用意する際の注意

読み手の考える量が減らすように変数を置け。

変数の暗黙ルール

- final修飾子をつける 
    - →可変なものは、常に値の変化を注意しなければならない。
- 中間結果はいちいち保存しない 
    - →中間結果を変数で置くと考える量が増えてしまう。省略するか、別メソッドで計算させる。
- スコープをなるべく狭く 
     - →初めにまとめて宣言してしまと、全てに気を付けなければならなくなる。また、初期化忘れやヌルポが起きうる。

---

### どっちがわかりやすい？

結果が出たら、関数から早く返す。

```java
              public boolean Contains(String str, String subStr) { 
              boolean tmp;
              if(str == null || subStr == null) tmp = false;
              if(subStr.equals ("")) tmp = true;

              ...
              
              return tmp;
              }
```


tmpはどこで変わるのか最後まで確認しなければいけない。

```java
              public boolean Contains(String str, String subStr) { 
                if(str == null || subStr == null) return false;
                if(subStr.equals ("")) return true;

                ...

              }
```

ある条件の時はそれ以上の処理がなくなるので、読み手が考える量が減る。

---

### どっちがわかりやすい？

```java
            public int method1(){       
              String str = null;
              int i = 0;

              str = method2.getStr();
              
              ...
              i = method3(str);

            }
```
            
そのメソッドの中で、常に変数の動きを気にしなければならない。(strの例ではヌルポが起こりうる。)

```java
              public int method1(){       
              String str = method2.getStr();
              
              ...
              final int i = method3(str);

            }
```

変数は頭で宣言せずに使うタイミングで宣言することで、スコープが短くなり、読み手の気にする量が減る。また初期化の処理なども不要になる。


---

### どっちがわかりやすい？

巨大な式は分割する。

            ※具体例募集（Javaの例が載ってなかったので…）

            
ネストが深いため、パッと見てもよくわからない。


              ※具体例募集（Javaの例が載ってなかったので…）
            
ネストが深いものは、そもそも複数のことを同時にやろうとしてることが多いので、複数のメソッドに分ける。そこに引数を入れてあげることで、一度に考えるべき量が減る。

---

### まとめ

なるべく読み手が考えるべき量を減らす。

暗黙のマナー

- 引数は多くて３つ
- 気になるものは先に処理してしまう
- resultは早めに返す。
- （※省略しましたが、複雑なロジックは整理できることも）

---

### その他、本に書いてないこと 

---


### コードレビューの際に言われたこと。

- ハードコーディングは避ける（数字やSQL文など。） 
    - →今後の変更を考える必要がある。
- ログは適切に吐く（スタックトレース情報を含む。） 
    - 詳しくはこちら→ログレベル
- 例外のレベルを適切に。握りつぶせばいいわけじゃない。
    - ループの中でSQLはダメ。出来る限り一度で取得しろ
- 何度も使う（かつ処理に時間のかかる）ものはローカル変数へ。
- nullは使うな。例外投げとけ（潜在的なバグになりやすい）



--- 

## 下書き

システムが扱う内容が複雑なものや、製品の寿命が長いものは、どうしてもコードも複雑になってしまうでしょう。
職場によっては、「まぁ仕方ないよね」なんて声も聞こえてくるかもしれません。

しかし、元々が複雑なコードでも原則をしっかり守れば、読めなくなることはないはずです。

ということで、まずはここで紹介するコードを汚さの基準値として持っておいて、
それ以上汚くなったら「もっと綺麗にしなきゃ」と心がけるようになれば上出来だと思います。

個別のテクニックよりも、そういった視点で自分のコードを見れるかが重要でしょう。

---

### こんなのやっても意味ないよ

綺麗なコードを書こう、というとこんな声が上がってきます。

- 費用対効果はどうなの？
- 頑張っても評価されないよね？
- そんなことより作りたい新機能があってさ

たしかに、短期的には損かもしれません。
しかし、いかにわかりやすく分割するか、無駄を省くかという知的作業を続けることで、
物事を抽象化して捉え、自身の思考プロセスを整理することに役立つと思います。

これらは、業務ドメインや言語を超えて通用するスキルだと思います。

