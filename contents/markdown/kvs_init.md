
## 最近のWebシステムの要件

- RDBじゃ遅い、もっと速く値を返して欲しい。
- DBは常に利用できるようにしてほしい。
- 超大量のデータを扱いたい。

→RDBの苦手な部分（高速・スケール）を補填するDBの必要性。

---

## 疑問

なんでこんなにたくさんの実装（NoSQLデータベース）があるのか？

→全ての要求を完璧に満たす分散DBが存在しないから（CAP定理・データモデル・永続化）


---

### CAP定理

![Link](./img/cap.png)

---

### CAP定理

- 分散システムに置いて、
- どのノードもいつでもアクセスできて、
- 常に一貫したデータを取得すること

は不可能。

**※ACIDのCとCAPのCは別モノなので注意。**

（※ ネットワーク障害を考慮しない単一DB系の場合はACになる。）

https://ja.wikipedia.org/wiki/CAP%E5%AE%9A%E7%90%86

---

### CAP定理


例

二台のDBサーバーでデータを分散して管理する。

この時、ネットワーク障害があると２つの選択が必要になる。

- どちらのノードも処理を継続する。ただしデータの一貫性が損なわれる（AP）
- 一貫性を維持するために、どちらかor両方のノードが処理を一時的に止める（CP）

このバランスをどう調節するかがDB選定の肝になる。

---

## クラスタ構成

---

## クラスタ構成

大きく二種類ある。

- マスタ・スレーブ型
	- 主にCPを確保しやすい。
- Dynamo型
	- 主にAPを確保しやすい。

---

## マスタ・スレーブ型

あるノードが特定の役割を持っているパターン。

分散DBにおいては、複数のマスタがいてそれぞれ独立してデータを管理している場合が多い。

もしマスタが死んだらスレーブの一つがマスタに昇格する。

---

## マスタ・スレーブ型

**利点**

- 一貫性を維持しやすい
- レイテンシが低い

**欠点**

- 役割変更（スレーブがマスタに昇格する）の際に不安定な時間がある。
- （一般にはその期間は書き込みを拒否する。）

---

## マスタ・スレーブ型

クライアント側で、

- クラスタに現在の構成を定期的に問い合わせたり、
- 特定のアルゴリズムを元にアクセス先を決定したりする。

![](./img/master-slave.png)

---

## マスタ・スレーブ型

クラスタの構成が変っても後から対応する。

![](./img/master-slave2.png)

---

## Dynamo型

全てのノードがフラットに並べられているパターン。
どのノードにアクセスがあっても、後述の仕組みで対象ノードへリダイレクトして処理する。

**利点**

- どのノードも常に書き込みできて可用性に優れる。

**欠点**

- データの一貫性を保証しにくい。
- リダイレクトする分レイテンシが高い。

---

### Quorum

読み書きの対象ノード数を調整することで、一貫性とレイテンシを調整することができる。

パラメータ `読み込みｍ、書き込みｎ、全ノードN、レプリカl`

![](./img/quorum.jpg)

---

### Quorum

`m+n > l; m,n < l` の場合は、一貫性を保証できる。

- 書き込み時に、lのうちn個のノードにも同期を行い完了したらレスポンスを返す。
- 読み込み時に、lのうちm個のノードに問い合わせて正しい値を返す（最新のTimestampだったり、VectorClockだったりする。）

[参考](http://stackoverflow.com/questions/31651487/how-does-cassandra-scale-horizontally)

---

## データモデル

---

## データモデル

NoSQLデータベースには、

- ドキュメント指向
- KVS
- 列指向
- グラフ指向などがある。

それぞれのデータモデルによって得意とする処理が異なり、
もし不得意な領域を選んでしまうと要件を満たせなかったり、パフォーマンスが劇的に劣化したりする。

---

## KVS

Javaで言うHashMapのように、Keyを渡すとValueを返してくれるような単純なデータ構造。

単純な分処理が速いが、複雑なことをする場合にはクライアント側での対応が必要。

---

## ドキュメント指向

あるデータに任意のデータを関連させることができ、その関連データに応じて複雑なクエリを投げることができる。
NoSQLにおいてはスキーマレスなことが多く、柔軟なデータ構造を扱える。

---

## 列指向

大量のレコードに対しての集計系のクエリに特化した構造。
内部的には、データを持っている各ノードでMapReduce的なことをしていることが多い。

[例](http://sssslide.com/www.slideshare.net/bunjik/couchbase-meetup7-n1ql)

---

## グラフ指向

調べてない。

---

## 永続化

---

## 永続化

データの管理方法にも色々ある。

ここでは、

- インメモリ/HDD
- 同期/非同期レプリケーション
- Index

に触れる。

---

## インメモリ/HDD(SSD)

インメモリだと、速いがプロセスが落ちるとデータが失われる。
HDDで永続化するのが安全だが、処理が遅くなる。

![](./img/hdd_memory.gif)

---

## 同期/非同期レプリケーション

データの更新のリクエストがあった際に、その内容を別ノードでも保存することで障害時のデータロストを防ぐ。

- 同期の場合は、別ノードへの複製が済んでからリクエスト完了とするので、安全だが遅い。
- 非同期の場合は、別ノードへの複製が終わる前にリクエスト完了とするので、速いが安全でない。

---

## Index

（KVSの文脈ではあまり出てこないので省略。。。）

---

## その他要素技術

---

## Gossip Protocol

クラスタ構成時に、各ノード全てとやりとりするとN * N-1個のコネクションが必要になり非効率なので、
隣同士の相談で合意形成する仕組み。（その代わり時間がかかる）

[参考](http://www.slideshare.net/akuwano/cassandra-4098052#21)

---

## Paxos

クラスタ内のノード間での合意形成アルゴリズム。
分散システムでの一貫性の確保に利用されているらしい。（Zookeeperとか）
詳しくは知らない。

[参考](http://www.slideshare.net/pfi/paxos-13615514)

---

## KVS紹介

---

## 一般的なKVS

- Redis
- Memcached
- Cassandra
- Riak
- CouchBase
- Aerospike
- KyotoTycoon
- Zookeeper

---

## 一般的なKVS

仕組みと特徴で分類していますが、

- 仕組み→製品コンセプトに近い部分、おそらく不変
- 特徴→仕組みから導かれる、現段階での定量的な指標。

あと、応答速度を書いていますが、だいたいの目安で。

（参考値：ローカルのメモリで0.05msくらい）

---

## Redis

- [リンク](http://redis.shibu.jp/admin/cluster/)
- [リンク](http://toufuegg.hatenablog.com/entry/2015/04/04/170309)
- [リンク](http://redis.io/topics/cluster-tutorial#creating-and-using-a-redis-cluster)
- [リンク](http://mocobeta-backup.tumblr.com/post/36435137765/kvs-memcached-couchbase-mongodb-redis)

---

### 一言で

高速かつ一貫性のある万能KVS。

---

### 仕組み

![](./img/hash_slots2.png)

- マスタ・スレーブ構成
- あるデータ（slot）に対するマスタは常に一つ。
- インメモリ
- 非同期レプリケーション・永続化
- 管轄外のデータへのリクエストはリダイレクトされる。
- シングルスレッド

---

### 特徴

- 1000台までのクラスタ構成を想定している。
- Binary/Hash/Set/Listなどのデータ型をサポート。
- プロキシを噛ませる必要がないため高速
- 非同期で複製するため、データが消失する恐れがあるが高速。
- データの一貫性はほぼ保つ。（障害時に稀に壊れる）
- string/binary/set/list/mapなどのデータ構造を格納可能。
- 各ノードのデータの分担量を細かくいじれる。
- CASをサポート。
- 0.5msくらい。

---

### 使用例

- データの復旧が可能なキャッシュサーバ。
- 多少データが壊れることを許容する大量データを、高速に処理したい場合。

---

## Memcached

---

### 一言で

超高速なサーバー間の共有メモリ。

http://gihyo.jp/dev/feature/01/memcached
http://www.slideshare.net/AmazonWebServices/dat207
http://qiita.com/taruhachi/items/a844bf373623991873ff

---

### 仕組み

![](./img/traditional_memcached_client.jpg)

---

### 仕組み

- クラスタ構成は擬似的なもので、ノード同士はコミュニケーションしない。
- クライアント側がどこにアクセスするか決める。（consistency hashing）
- マスタデータは基本的に一箇所のみで複製もされない（揮発データ前提）
- データが保有メモリ量を超えると古いものから消されていく

---

### 特徴

- 揮発性データを扱うこと前提。
- 障害時のデータの一貫性に難あり？
- 0.2msくらい

データが消えてもいいからとにかく高速な読み書きがしたい場合のキャッシュサーバ

---

### 疑問

- ノード追加時にクライアントがどうやってそれを知るのか？
- 各クライアントで、対象ノード決定のアルゴリズムは統一できるのか？

---

## Cassandra

http://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlClientRequestsWrite.html
http://www.slideshare.net/doanduyhai/cassandra-introduction-40711134

---

### 一言で

複雑なクエリに強いKVS

---

### 仕組み

- Dynamoベース
- 読み書きノードを設定することでCAPの程度を調整可能
- filter、rangeでのクエリが可能

---

### 特徴

- SQLに近いクエリ（CQL）を扱える。
- CASサポート
- データセンター間での連携も可能
- Appleなど、超大規模（１０万ノード、PB級）での[実績あり](http://itpro.nikkeibp.co.jp/atcl/column/15/061500148/100500026/?rt=nocnt)
- データ構造の違う複数テーブルを扱える。
- 一貫性とパフォーマンスの度合いを調整できる。
- 10msくらい。

---

### 疑問

- 高機能なのであまり調べられてない。

---

## riak

http://www.slideshare.net/takahikosato/riak-24796781
http://www.slideshare.net/scixer/riak-28885715?related=1
http://www.slideshare.net/takahikosato/riak-24796781#30
https://speakerdeck.com/ksauzz/fen-san-detabesu-riak-to-obuziekutosutorezi-riakcs#9

---

### 一言で

運用が楽なKVS

---

### 仕組み
- Dynamo論文ベース
- 単純なKeyValueを扱う
- 障害時に他ノードへのデータの一時的な退避、復旧時に元に戻すなどを自動で行う。

---

### 特徴

- 障害時の処理が充実している。（中の人曰く、「障害が起きたら翌朝対応すればいい。」）
- MapReduce系、全文検索系の仕組みが充実してるらしい。
- 5msくらい

---

## couchbase

http://www.slideshare.net/CouchbaseJapan/couchbase-introduction20150611
http://www.couchbase.com/nosql-resources/presentations/couchbase-server-101.html

---

### 一言で

速くて万能なドキュメント指向データベース

---

### 仕組み

- マスタ・スレーブ型
- クライアント側が、データを格納しているノードを計算してアクセスする。

---

### 特徴

- 周辺ツールが充実しているっぽい。
- 柔軟なクエリを投げられる。
- データセンター間レプリケーションなどできるらしい。
- memcached互換のプラグインがある。
- 読み書きともに1msくらい。

---

## Aerospike

http://blog.hirokikana.com/?p=590

---

### 一言で

Redisのさらに永続化強くしたやつ。

---

### 仕組み

- 詳しく調べてない。
- マスタースレーブ式
- あるデータは一つのマスタが管理している。
- クライアントが対象のマスタを選んでやりとりする。
- 同期レプリケーション・永続化を行いつつも高速。

---

### 特徴

- 詳しく調べてない
- 同期的に永続化してるのに速い。

---

## kyototycoon

---

### 一言で

オワコン？（メンテされてなく、古い資料しかない）

